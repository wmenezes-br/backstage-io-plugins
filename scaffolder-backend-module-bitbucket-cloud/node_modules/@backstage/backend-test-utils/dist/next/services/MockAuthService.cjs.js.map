{"version":3,"file":"MockAuthService.cjs.js","sources":["../../../src/next/services/MockAuthService.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  BackstageCredentials,\n  BackstageServicePrincipal,\n  BackstagePrincipalTypes,\n  BackstageUserPrincipal,\n  BackstageNonePrincipal,\n  AuthService,\n} from '@backstage/backend-plugin-api';\nimport { AuthenticationError } from '@backstage/errors';\nimport {\n  mockCredentials,\n  MOCK_USER_TOKEN,\n  MOCK_USER_TOKEN_PREFIX,\n  MOCK_INVALID_USER_TOKEN,\n  MOCK_USER_LIMITED_TOKEN_PREFIX,\n  MOCK_INVALID_USER_LIMITED_TOKEN,\n  MOCK_SERVICE_TOKEN,\n  MOCK_SERVICE_TOKEN_PREFIX,\n  MOCK_INVALID_SERVICE_TOKEN,\n  UserTokenPayload,\n  ServiceTokenPayload,\n} from './mockCredentials';\nimport { JsonObject } from '@backstage/types';\n\n/** @internal */\nexport class MockAuthService implements AuthService {\n  readonly pluginId: string;\n  readonly disableDefaultAuthPolicy: boolean;\n\n  constructor(options: {\n    pluginId: string;\n    disableDefaultAuthPolicy: boolean;\n  }) {\n    this.pluginId = options.pluginId;\n    this.disableDefaultAuthPolicy = options.disableDefaultAuthPolicy;\n  }\n\n  async authenticate(\n    token: string,\n    options?: { allowLimitedAccess?: boolean },\n  ): Promise<BackstageCredentials> {\n    switch (token) {\n      case MOCK_USER_TOKEN:\n        return mockCredentials.user();\n      case MOCK_SERVICE_TOKEN:\n        return mockCredentials.service();\n      case MOCK_INVALID_USER_TOKEN:\n        throw new AuthenticationError('User token is invalid');\n      case MOCK_INVALID_USER_LIMITED_TOKEN:\n        throw new AuthenticationError('Limited user token is invalid');\n      case MOCK_INVALID_SERVICE_TOKEN:\n        throw new AuthenticationError('Service token is invalid');\n      case '':\n        throw new AuthenticationError('Token is empty');\n      default:\n        break;\n    }\n\n    if (token.startsWith(MOCK_USER_TOKEN_PREFIX)) {\n      const { sub: userEntityRef }: UserTokenPayload = JSON.parse(\n        token.slice(MOCK_USER_TOKEN_PREFIX.length),\n      );\n\n      return mockCredentials.user(userEntityRef);\n    }\n\n    if (token.startsWith(MOCK_USER_LIMITED_TOKEN_PREFIX)) {\n      if (!options?.allowLimitedAccess) {\n        throw new AuthenticationError('Limited user token is not allowed');\n      }\n\n      const { sub: userEntityRef }: UserTokenPayload = JSON.parse(\n        token.slice(MOCK_USER_LIMITED_TOKEN_PREFIX.length),\n      );\n\n      return mockCredentials.user(userEntityRef);\n    }\n\n    if (token.startsWith(MOCK_SERVICE_TOKEN_PREFIX)) {\n      const { sub, target, obo }: ServiceTokenPayload = JSON.parse(\n        token.slice(MOCK_SERVICE_TOKEN_PREFIX.length),\n      );\n\n      if (target && target !== this.pluginId) {\n        throw new AuthenticationError(\n          `Invalid mock token target plugin ID, got '${target}' but expected '${this.pluginId}'`,\n        );\n      }\n      if (obo) {\n        return mockCredentials.user(obo);\n      }\n\n      return mockCredentials.service(sub);\n    }\n\n    throw new AuthenticationError(`Unknown mock token '${token}'`);\n  }\n\n  async getNoneCredentials() {\n    return mockCredentials.none();\n  }\n\n  async getOwnServiceCredentials(): Promise<\n    BackstageCredentials<BackstageServicePrincipal>\n  > {\n    return mockCredentials.service(`plugin:${this.pluginId}`);\n  }\n\n  isPrincipal<TType extends keyof BackstagePrincipalTypes>(\n    credentials: BackstageCredentials,\n    type: TType,\n  ): credentials is BackstageCredentials<BackstagePrincipalTypes[TType]> {\n    const principal = credentials.principal as\n      | BackstageUserPrincipal\n      | BackstageServicePrincipal\n      | BackstageNonePrincipal;\n\n    if (type === 'unknown') {\n      return true;\n    }\n\n    if (principal.type !== type) {\n      return false;\n    }\n\n    return true;\n  }\n\n  async getPluginRequestToken(options: {\n    onBehalfOf: BackstageCredentials;\n    targetPluginId: string;\n  }): Promise<{ token: string }> {\n    const principal = options.onBehalfOf.principal as\n      | BackstageUserPrincipal\n      | BackstageServicePrincipal\n      | BackstageNonePrincipal;\n\n    if (principal.type === 'none' && this.disableDefaultAuthPolicy) {\n      return { token: '' };\n    }\n\n    if (principal.type !== 'user' && principal.type !== 'service') {\n      throw new AuthenticationError(\n        `Refused to issue service token for credential type '${principal.type}'`,\n      );\n    }\n\n    return {\n      token: mockCredentials.service.token({\n        onBehalfOf: options.onBehalfOf,\n        targetPluginId: options.targetPluginId,\n      }),\n    };\n  }\n\n  async getLimitedUserToken(\n    credentials: BackstageCredentials<BackstageUserPrincipal>,\n  ): Promise<{ token: string; expiresAt: Date }> {\n    if (credentials.principal.type !== 'user') {\n      throw new AuthenticationError(\n        `Refused to issue limited user token for credential type '${credentials.principal.type}'`,\n      );\n    }\n\n    return {\n      token: mockCredentials.limitedUser.token(\n        credentials.principal.userEntityRef,\n      ),\n      expiresAt: new Date(Date.now() + 3600_000),\n    };\n  }\n\n  listPublicServiceKeys(): Promise<{ keys: JsonObject[] }> {\n    throw new Error('Not implemented');\n  }\n}\n"],"names":["MOCK_USER_TOKEN","mockCredentials","MOCK_SERVICE_TOKEN","MOCK_INVALID_USER_TOKEN","AuthenticationError","MOCK_INVALID_USER_LIMITED_TOKEN","MOCK_INVALID_SERVICE_TOKEN","MOCK_USER_TOKEN_PREFIX","MOCK_USER_LIMITED_TOKEN_PREFIX","MOCK_SERVICE_TOKEN_PREFIX"],"mappings":"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"}