{"version":3,"file":"sqlite.cjs.js","sources":["../../src/database/sqlite.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport knexFactory, { Knex } from 'knex';\nimport { Engine, TestDatabaseProperties } from './types';\n\nexport class SqliteEngine implements Engine {\n  static async create(\n    properties: TestDatabaseProperties,\n  ): Promise<SqliteEngine> {\n    return new SqliteEngine(properties);\n  }\n\n  readonly #properties: TestDatabaseProperties;\n  readonly #instances: Knex[];\n\n  constructor(properties: TestDatabaseProperties) {\n    this.#properties = properties;\n    this.#instances = [];\n  }\n\n  async createDatabaseInstance(): Promise<Knex> {\n    const instance = knexFactory({\n      client: this.#properties.driver,\n      connection: ':memory:',\n      useNullAsDefault: true,\n    });\n\n    instance.client.pool.on('createSuccess', (_eventId: any, resource: any) => {\n      resource.run('PRAGMA foreign_keys = ON', () => {});\n    });\n\n    this.#instances.push(instance);\n    return instance;\n  }\n\n  async shutdown(): Promise<void> {\n    for (const instance of this.#instances) {\n      await instance.destroy();\n    }\n  }\n}\n"],"names":["knexFactory"],"mappings":";;;;;;;;AAmBO,MAAM,YAA+B,CAAA;AAAA,EAC1C,aAAa,OACX,UACuB,EAAA;AACvB,IAAO,OAAA,IAAI,aAAa,UAAU,CAAA,CAAA;AAAA,GACpC;AAAA,EAES,WAAA,CAAA;AAAA,EACA,UAAA,CAAA;AAAA,EAET,YAAY,UAAoC,EAAA;AAC9C,IAAA,IAAA,CAAK,WAAc,GAAA,UAAA,CAAA;AACnB,IAAA,IAAA,CAAK,aAAa,EAAC,CAAA;AAAA,GACrB;AAAA,EAEA,MAAM,sBAAwC,GAAA;AAC5C,IAAA,MAAM,WAAWA,4BAAY,CAAA;AAAA,MAC3B,MAAA,EAAQ,KAAK,WAAY,CAAA,MAAA;AAAA,MACzB,UAAY,EAAA,UAAA;AAAA,MACZ,gBAAkB,EAAA,IAAA;AAAA,KACnB,CAAA,CAAA;AAED,IAAA,QAAA,CAAS,OAAO,IAAK,CAAA,EAAA,CAAG,eAAiB,EAAA,CAAC,UAAe,QAAkB,KAAA;AACzE,MAAS,QAAA,CAAA,GAAA,CAAI,4BAA4B,MAAM;AAAA,OAAE,CAAA,CAAA;AAAA,KAClD,CAAA,CAAA;AAED,IAAK,IAAA,CAAA,UAAA,CAAW,KAAK,QAAQ,CAAA,CAAA;AAC7B,IAAO,OAAA,QAAA,CAAA;AAAA,GACT;AAAA,EAEA,MAAM,QAA0B,GAAA;AAC9B,IAAW,KAAA,MAAA,QAAA,IAAY,KAAK,UAAY,EAAA;AACtC,MAAA,MAAM,SAAS,OAAQ,EAAA,CAAA;AAAA,KACzB;AAAA,GACF;AACF;;;;"}